name: Deploy GitHub Project to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        repository: "MarcosSuntaxi/HelloWorldHTML"

    - name: Set up SSH Key
      run: |
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private-key.pem
        chmod 600 private-key.pem

    - name: Prepare EC2 Target Directory
      run: |
        ssh -o StrictHostKeyChecking=no -i private-key.pem ubuntu@ec2-52-90-38-140.compute-1.amazonaws.com "mkdir -p /home/ubuntu/project"

    - name: Copy Project Files to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i private-key.pem -r ./* ubuntu@ec2-52-90-38-140.compute-1.amazonaws.com:/home/ubuntu/project/

    - name: Deploy Application on EC2
      run: |
        ssh -o StrictHostKeyChecking=no -i private-key.pem ubuntu@ec2-52-90-38-140.compute-1.amazonaws.com << 'EOF'
          # Update and install necessary packages
          sudo apt update -y
          sudo apt install nginx git -y

          # Clone the repository
          cd /home/ubuntu/project
          git clone https://github.com/MarcosSuntaxi/HelloWorldHTML.git .

          # Copy project files to the Nginx root directory
          sudo cp -r /home/ubuntu/project/* /var/www/html/

          # Start and enable Nginx
          sudo systemctl start nginx
          sudo systemctl enable nginx
        EOF

    - name: Verify Deployment
      run: |
        curl http://ec2-52-90-38-140.compute-1.amazonaws.com
